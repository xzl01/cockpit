"use strict";(()=>{function x(...d){(window.debugging==="all"||window.debugging?.includes("login"))&&console.debug("login:",...d)}(function(d){let p;try{p=window.localStorage,window.localStorage.removeItem("url-root"),window.localStorage.removeItem("standard-login")}catch(e){p=window.sessionStorage,d.warn(String(e))}let R=p.getItem("shell:style")||"auto";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&R==="auto"||R==="dark"?document.documentElement.classList.add("pf-v5-theme-dark"):document.documentElement.classList.remove("pf-v5-theme-dark"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{e.matches&&R==="auto"||R==="dark"?document.documentElement.classList.add("pf-v5-theme-dark"):document.documentElement.classList.remove("pf-v5-theme-dark")});let h,l=window.environment||{},b=l.OAuth||null;b&&(b.TokenParam||(b.TokenParam="access_token"),b.ErrorParam||(b.ErrorParam="error_description"));let re=/\$\{([^}]+)\}|\$([a-zA-Z0-9_]+)/g;function y(e){let t=Array.prototype.slice.call(arguments,1);return e.replace(re,function(n,o,r){return t[o||r]||""})}function J(e){if(window.cockpit_po){let t=window.cockpit_po[e];if(t&&t[1])return t[1]}return e}function ae(){if(!document.querySelectorAll)return;let e=document.querySelectorAll("[translate]");for(let t=0;t<e.length;t++)e[t].textContent=J(e[t].textContent)}let s=J,_,k,N,E,se=/[?&]?([^=]+)=([^&]*)/g,S=null;function M(e){e=e.split("+").join(" ");let t={};for(;;){let n=se.exec(e);if(!n)break;t[decodeURIComponent(n[1])]=decodeURIComponent(n[2])}return t}d||(d=function(){});function i(e){return document.getElementById(e)}function W(e){return e.replace(/^.*@/,"").replace(/(?<!:):[0-9]+$/,"").replace(/^\[/,"").replace(/\]$/,"")}function w(e,t){typeof e=="string"&&(e=[e]);for(let n=0;n<e.length;n++)if(typeof e[n]=="string"){let o=document.querySelectorAll(e[n]);o&&o.forEach(function(r){r.hidden!==!!t&&(r.hidden=!!t)})}else e[n].hidden!==!!t&&(e[n].hidden=!!t)}function g(){w(arguments,!1)}function f(){w(arguments,!0)}function le(e){window.console&&d.warn("stderr:",e),f("#login-wait-validating"),f("#login","#login-details"),g("#login-fatal"),i("login-again").onclick=()=>{f("#login-fatal"),A()},g("#login-again");let t=i("login-fatal-message");t.textContent="",t.appendChild(document.createTextNode(e))}function v(e){window.console&&d.warn("fatal:",e),f("#login-again","#login-wait-validating"),S&&(i("login-again").href=S,g("#login-again")),f("#login","#login-details"),g("#login-fatal");let t=i("login-fatal-message");t.textContent="",t.appendChild(document.createTextNode(e))}function q(e,t){let n=i(e),o=n&&window.getComputedStyle?window.getComputedStyle(n,":before"):null;if(!o)return;let r=o.content;if(r&&r!="none"&&r!="normal"){let a=r.length;(r[0]==='"'||r[0]==="'")&&a>2&&r[a-1]===r[0]&&(r=r.substr(1,a-2)),n.innerHTML=r||t}else n.removeAttribute("class")}function ce(){function e(a){a?(g("#login","#login-details","#login-override"),f("#get-out-link"),i("login-override-content").appendChild(i("login")),i("login-button").classList.add("pf-m-warning"),document.querySelector("#login .login-actions").insertAdjacentHTML("beforebegin","<div class='pf-v5-c-helper-text pf-m-warning' id='bypass-warning'>"+s("Cockpit might not render correctly in your browser")+"</div>")):f("#login","#login-details","#login-override")}function t(a,u){a==="supports"&&(a="@supports API");let L=y(s("This web browser is too old to run the Web Console (missing $0)"),a);window.console&&d.warn(L),i("login-error-message").textContent=L,g("#unsupported-browser","#error-group"),document.body.classList.add("unsupported-browser"),e(u)}function n(a,u){let L;try{L=u&&u[a]}catch(we){throw v(y(s("The web browser configuration prevents Cockpit from running (inaccessible $0)"),a)),we}return L===void 0?(t(a),!1):!0}function o(){let a=[].join.call(arguments,": ");return!window.CSS||!window.CSS.supports.apply(this,arguments)?(t(a,"bypass"),!1):!0}return n("WebSocket",window)&&n("XMLHttpRequest",window)&&n("sessionStorage",window)&&n("JSON",window)&&n("defineProperty",Object)&&n("console",window)&&n("pushState",window.history)&&n("textContent",document)&&n("replaceAll",String.prototype)&&n("finally",Promise.prototype)&&n("supports",window.CSS)?(o("display","flex")&&o("display","grid")&&o("selector(test)")&&o("selector(:is(*):where(*))"),!0):!1}function X(e){return e.replace(/^\s+|\s+$/g,"")}function B(e){let t=document.createElement("a"),n=document.baseURI;e=e||"/",t.href=n,t.pathname!="/"&&(h=t.pathname.replace(/^\/+|\/+$/g,""),p.setItem("url-root",h),h&&e.indexOf("/"+h)===0&&(e=e.replace("/"+h,"")||"/")),e.indexOf("/=")===0?(l.hostname=e.substring(2).split("/")[0],i("server-field").value=l.hostname,T(null,!0),e="/cockpit+"+e.split("/")[1]):e.indexOf("/cockpit/")!==0&&e.indexOf("/cockpit+")!==0&&(e="/cockpit"),k=e.split("/")[1],_="/"+k+"/login",h&&(_="/"+h+_),E=k,N=_}function T(e,t){e&&e.type==="keypress"&&e.key!==" "||(e&&e.type==="click"&&e.preventDefault(),t===void 0&&(t=i("server-group").hidden),w("#server-group",!t),i("option-group").setAttribute("data-state",t))}function de(e){let t=i("login-password-input");t.setAttribute("type",t.getAttribute("type")==="password"?"text":"password"),e.stopPropagation()}function pe(){let e=l.logged_into||[],t=e.length>0?e[0]:null;function n(){P(t==="."?"/":"/="+t)}t&&!l.page.allow_multihost&&n()}function fe(){window.onload=null,ae(),window.cockpit_po&&window.cockpit_po[""]&&(document.documentElement.lang=window.cockpit_po[""].language,window.cockpit_po[""]["language-direction"]&&(document.documentElement.dir=window.cockpit_po[""]["language-direction"])),pe(),B(window.location.pathname),(window.location.pathname.indexOf("/"+h+"/cockpit/")===0||window.location.pathname.indexOf("/"+h+"/cockpit+")===0)&&document.documentElement.setAttribute("class","inline");let e=l.page.title;if(l.is_cockpit_client&&(e=s("Login")),(!e||k.indexOf("cockpit+=")===0)&&(e=l.hostname),document.title=e,k.indexOf("cockpit+=")===0?f("#brand","#badge"):(q("badge",""),q("brand","Cockpit")),!ce())return;l.banner&&(g("#banner"),i("banner-message").textContent=l.banner.trimEnd()),i("bypass-browser-check").addEventListener("click",T),i("bypass-browser-check").addEventListener("keypress",T),i("show-other-login-options").addEventListener("click",T),i("show-other-login-options").addEventListener("keypress",T),i("server-clear").addEventListener("click",function(){let o=i("server-field");o.value="",o.focus()});let t=window.sessionStorage.getItem("logout-intent")=="explicit";t&&window.sessionStorage.removeItem("logout-intent");let n=window.sessionStorage.getItem("logout-reason");n&&window.sessionStorage.removeItem("logout-reason"),b?(f("#login-details","#login"),t?(j(),i("login-again").textContent=s("Login again"),v(s("Logout successful"))):ue()):t?A(n):F()?A():ge()}function ge(){let e=new XMLHttpRequest;e.open("GET",_,!0),e.onreadystatechange=function(){e.readyState==4&&(e.status==200?$(JSON.parse(e.responseText)):e.status==401?A():e.statusText?v(decodeURIComponent(e.statusText)):e.status===0?A():v(y(s("$0 error"),e.status)))},e.send()}function j(){let e=window.location.href.split("#",2);S=b.URL,b.URL.indexOf("?")>-1?S+="&":S+="?",S+="redirect_uri="+encodeURIComponent(e[0])}function ue(){let e=document.createElement("a");if(!b.URL)return v(s("Cockpit authentication is configured incorrectly."));let t=!window.location.search&&window.location.hash?M(window.location.hash.slice(1)):M(window.location.search);if(j(),t[b.TokenParam]){window.sessionStorage.getItem("login-wanted")&&(e.href=window.sessionStorage.getItem("login-wanted"),B(e.pathname));let n=t[b.TokenParam];g("#login-wait-validating");let o=new XMLHttpRequest;o.open("GET",_,!0),o.setRequestHeader("Authorization","Bearer "+n),o.onreadystatechange=function(){if(o.readyState==4)if(o.status==200)$(JSON.parse(o.responseText));else{let r=oe(o.getResponseHeader("WWW-Authenticate"),o.responseText);r?ee(r):v(decodeURIComponent(o.statusText))}},o.send()}else t[b.ErrorParam]?v(t[b.ErrorParam]):(window.sessionStorage.setItem("login-wanted",window.location.href),window.location=S)}function G(){f("#error-group"),i("login-error-message").textContent=""}function D(){f("#info-group"),i("login-info-message").textContent=""}function m(e,t,n){G(),e&&(b?v(e):(O(n||"login"),i("login-error-title").textContent=e,i("login-error-message").textContent=t,w("#error-group .pf-v5-c-alert__description",!t),g("#error-group")))}function me(e){D(),e&&(i("login-info-message").textContent=e,g("#info-group"))}function H(e,t){c?(G(),i("login-error-title").textContent=e,i("login-error-message").textContent=t,w("#error-group .pf-v5-c-alert__description",!t),g("#error-group"),T(null,!0),O("login")):m(t)}function be(e){let t=i("login-note");e?(g(t),t.textContent=e):t.innerHTML="&nbsp;"}function F(){return l.page.require_host&&E.indexOf("cockpit+=")===-1}function Q(){let e=[];try{e=JSON.parse(p.getItem("cockpit-client-sessions")||"[]")}catch(t){d.log("Failed to parse 'cockpit-client-sessions':",t)}return e}let c=null,z=null,C=null;function I(){m(null),c=i("server-field").value,z=null;let e=X(i("login-user-input").value);if(e===""&&!l.is_cockpit_client)m(s("User name cannot be empty"));else if(F()&&c==="")m(s("Please specify the host to connect to"));else{c?(k="cockpit+="+c,_=N.replace("/"+E+"/","/"+k+"/"),i("brand").style.display="none",i("badge").style.visibility="hidden"):(k=E,_=N,q("badge",""),q("brand","Cockpit")),i("server-name").textContent=c||l.hostname,i("login-button").removeEventListener("click",I);let t=i("login-password-input").value,n="superuser:"+e+(c?":"+c:""),o=p.getItem(n)||"none";p.setItem("superuser-key",n),p.setItem(n,o),p.setItem("standard-login",!0);let r="";if(c)if(C==c)x("call_login(): previous login attempt into",c,"failed due to changed key");else{let u=Z(c);u?(x("call_login(): sending known_host key",u,"for logging into",c),r=u):x("call_login(): no known_hosts entry for logging into",c)}let a={Authorization:"Basic "+window.btoa(te(e+":"+t+"\0"+r)),"X-Superuser":o};c&&(a["X-SSH-Connect-Unknown-Hosts"]="yes"),ne("GET",a,!1)}}function V(){let e=Q(),t=i("recent-hosts-list");t.innerHTML="",e.forEach(n=>{let o=document.createElement("div");o.classList.add("host-line");let r=document.createElement("button");r.textContent=n,r.classList.add("pf-v5-c-button","pf-m-tertiary","host-name"),r.addEventListener("click",()=>{i("server-field").value=n,I()});let a=document.createElement("button");a.title=s("Remove host"),a.ariaLabel=a.title,a.classList.add("host-remove"),a.addEventListener("click",()=>{let u=e.indexOf(n);e.splice(u,1),p.setItem("cockpit-client-sessions",JSON.stringify(e)),V()}),o.append(r,a),t.append(o)}),w("#recent-hosts",e.length==0)}function O(e){let t=l.page.connect,n=i("option-group").getAttribute("data-state");if(f("#login-wait-validating"),g("#login"),w("#login-details",l.is_cockpit_client),w("#server-field-label",l.is_cockpit_client),l.is_cockpit_client){let o=i("brand");o.textContent=s("Connect to:"),o.classList.add("text-brand")}w(["#user-group","#password-group"],e!="login"||l.is_cockpit_client),w("#conversation-group",e!="conversation"),w("#hostkey-group",e!="hostkey"),i("login-button-text").textContent=e=="hostkey"?s("Accept key and log in"):s("Log in"),e!="login"&&(i("login-password-input").value=""),l.page.require_host?(f("#option-group"),n=!0):w("#option-group",!t||e!="login"),!t||e!="login"?f("#server-group"):w("#server-group",!n),i("login-button").removeAttribute("disabled"),i("login-button").removeAttribute("spinning"),i("login-button").classList.remove("pf-m-danger"),i("login-button").classList.add("pf-m-primary"),f("#get-out-link"),e=="login"&&i("login-button").addEventListener("click",I),l.is_cockpit_client&&(V(),document.body.classList.add("cockpit-client"))}function A(e){me(e),i("server-name").textContent=document.title,be(s("Log in with your server user account.")),i("login-user-input").addEventListener("keydown",function(n){m(null),D(),n.which==13&&i("login-password-input").focus()},!1);let t=function(n){m(null),n.which==13&&I()};i("login-password-input").addEventListener("keydown",t),i("login-password-toggle").addEventListener("click",de),O("login"),l.is_cockpit_client?l.page.require_host&&i("server-field").focus():i("login-user-input").focus()}function Y(){try{return JSON.parse(p.getItem("known_hosts")||"{ }")}catch(e){return d.warn("Can't parse known_hosts database in localStorage",e),{}}}function Z(e){return Y()[W(e)]}function K(e,t){try{let n=Y();n[W(e)]=t,p.setItem("known_hosts",JSON.stringify(n))}catch(n){d.warn("Can't write known_hosts database to localStorage",n)}}function he(e){let t=e["host-key"],n=t.split(" ")[0],o=t.split(" ")[1],r=Z(n);r?(x("do_hostkey_verification: received key fingerprint",e.default,"for host",n,"does not match key in known_hosts database:",r,"; treating as changed"),i("hostkey-title").textContent=y(s("$0 key changed"),c),g("#hostkey-warning-group"),i("hostkey-message-1").textContent=""):(x("do_hostkey_verification: received key fingerprint",e.default,"for host",n,"not in known_hosts database; treating as new host"),i("hostkey-title").textContent=s("New host"),f("#hostkey-warning-group"),i("hostkey-message-1").textContent=y(s("You are connecting to $0 for the first time."),c)),i("hostkey-verify-help-1").textContent=y(s("To verify a fingerprint, run the following on $0 while physically sitting at the machine or through a trusted network:"),c),i("hostkey-verify-help-cmds").textContent=y("ssh-keyscan$0 localhost | ssh-keygen -lf -",o?" -t "+o:""),i("hostkey-fingerprint").textContent=e.default,o?(i("hostkey-type").textContent=y("($0)",o),g("#hostkey-type")):f("#hostkey-type"),m("");function a(){i("login-button").removeEventListener("click",a),m(null,null,"hostkey"),t.endsWith(" login-data")?(z=n,x("call_converse(): got placeholder host keyfor",z,", deferring db update"),ie(e.id,e.default)):(d.error("login: got unexpected host key prompt, expecting login-data placeholder:",t),v(s("Internal protocol error")))}i("login-button").addEventListener("click",a),O("hostkey"),g("#get-out-link"),r&&(i("login-button").classList.add("pf-m-danger"),i("login-button").classList.remove("pf-m-primary"))}function ee(e){if(e["host-key"]){he(e);return}let t=e.echo?"text":"password";i("conversation-prompt").textContent=e.prompt;let n=i("conversation-message"),o=e.error||e.message;o?(n.textContent=o,g(n)):f(n);let r=i("conversation-input");r.value="",e.default&&(r.value=e.default),r.setAttribute("type",t),m("");function a(){i("conversation-input").removeEventListener("keydown",u),i("login-button").removeEventListener("click",a),m(null,null,"conversation"),ie(e.id,i("conversation-input").value)}function u(L){m(null,null,"conversation"),L.which==13&&a()}i("conversation-input").addEventListener("keydown",u),i("login-button").addEventListener("click",a),O("conversation"),r.focus()}function te(e){return window.unescape(encodeURIComponent(e))}function oe(e,t){if(!e)return null;let n=e.split(" ");if(n[0].toLowerCase()!=="x-conversation"&&n.length!=3)return null;let o=n[1],r;try{r=window.atob(n[2])}catch(u){return window.console&&d.error("Invalid prompt data",u),null}let a;try{a=JSON.parse(t)}catch(u){window.console&&d.log("Got invalid JSON response for prompt data",u),a={}}return a.id=o,a.prompt=r,a}function ne(e,t,n){x("send_login_request():",e,"headers:",JSON.stringify(t)),i("login-button").setAttribute("disabled","true"),i("login-button").setAttribute("spinning","true");let o=new XMLHttpRequest;o.open(e,_,!0);for(let r in t)o.setRequestHeader(r,t[r]);o.onreadystatechange=function(){if(o.readyState==4)if(o.status==200){let r=JSON.parse(o.responseText);$(r)}else if(o.status==401){x("send_login_request():",e,"got 401, status:",o.statusText,"; response:",o.responseText);let r=o.getResponseHeader("WWW-Authenticate");if(r&&r.toLowerCase().indexOf("x-conversation")===0){let a=oe(r,o.responseText);a?ee(a):v(s("Internal error: Invalid challenge header"))}else{if(window.console&&d.log(o.statusText),C)try{let a=JSON.parse(o.responseText)["known-hosts"];a?(x("send_login_request(): got updated known-hosts for changed host keys of",C,":",a),K(C,a),C=null):x("send_login_request():",C,"changed key, but did not get an updated key from response")}catch(a){d.error("Failed to parse response text as JSON:",o.responseText,":",JSON.stringify(a))}if(o.statusText.startsWith("captured-stderr:"))le(decodeURIComponent(o.statusText.replace(/^captured-stderr:/,"")));else if(o.statusText.indexOf("authentication-not-supported")>-1){let a=X(i("login-user-input").value);v(y(s("The server refused to authenticate '$0' using password authentication, and no other supported authentication methods are available."),a))}else o.statusText.indexOf("terminated")>-1?m(s("Authentication failed"),s("Server closed connection")):o.statusText.indexOf("no-host")>-1?H(s("Unable to connect to that address")):o.statusText.indexOf("unknown-hostkey")>-1?H(s("Refusing to connect"),s("Hostkey is unknown")):o.statusText.indexOf("unknown-host")>-1?H(s("Refusing to connect"),s("Host is unknown")):o.statusText.indexOf("invalid-hostkey")>-1?C===null?(x("send_login_request(): invalid-hostkey, trying again to let the user confirm"),C=c,I()):(x("send_login_request(): invalid-hostkey, and already retried, giving up"),H(s("Refusing to connect"),s("Hostkey does not match"))):n?m(s("Authentication failed")):m(s("Authentication failed"),s("Wrong user name or password"))}}else if(o.status==403){let r=decodeURIComponent(o.statusText).trim();m(s("Permission denied"),r==="Permission denied"?"":r)}else if(o.status==500&&o.statusText.indexOf("no-cockpit")>-1){let r=y(s("Install the cockpit-system package (and optionally other cockpit packages) on $0 to enable web console access."),c||"localhost"),a=JSON.parse(o.responseText);a.supported&&(r=y(s("Transient packageless sessions require the same operating system and version, for compatibility reasons: $0."),a.supported)+" "+r),m(s("Packageless session unavailable"),r)}else o.statusText?v(decodeURIComponent(o.statusText)):v(y(s("$0 error"),o.status))},o.send()}function ie(e,t){let n={Authorization:"X-Conversation "+e+" "+window.btoa(te(t))};ne("GET",n,!0)}function P(e){let t=window.setTimeout(function(){t=null,window.location.reload(!0)},100);e&&e!=window.location.href&&(window.location=e),window.onbeforeunload=function(){t&&window.clearTimeout(t),t=null}}function U(e,t,n){let o=0;for(;o<e.length;){let r=e.key(o);n&&r.indexOf("cockpit")!==0||r.indexOf(t)===0?e.removeItem(r):o++}}function ke(e){if(U(window.sessionStorage,k,!0),p.removeItem("login-data"),U(p,k,!1),e&&e["login-data"]){let n=JSON.stringify(e["login-data"]);if(p.setItem(k+"login-data",n),p.setItem("login-data",n),z){let o=e["login-data"]["known-hosts"];o?(d.debug("setup_localstorage(): updating known_hosts database for deferred host key for",z,":",o),K(z,o)):d.error("login.js internal error: setup_localstorage() received a pending login-data host, but login-data does not contain known-hosts")}}h&&p.setItem("url-root",h);let t=l.CACertUrl;t&&window.sessionStorage.setItem("CACertUrl",t)}function $(e){let t=window.sessionStorage.getItem("login-wanted"),n=i("server-field").value;if(n&&l.is_cockpit_client){let o=Q();o.indexOf(n)<0&&(o.push(n),p.setItem("cockpit-client-sessions",JSON.stringify(o)))}n&&k!=E&&(t="/="+n,h&&(t="/"+h+t)),U(window.sessionStorage,k,!1),ke(e),P(t)}window.onload=fe})(window.console);})();
